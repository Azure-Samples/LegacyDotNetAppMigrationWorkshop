# Migrate Source Apps to PAAS

## Overview

In this lab, you will learn how to migrate legacy applications to PaaS. You will learn how to:

* Migrate a legacy application from an Azure VM to Azure App Service
* Create a GitHub workflow and deploy the application to the Azure App Service
* Update the connection string in the App Settings of the App Service

## Prerequisites

* Legacy applications and environment from [previous lab](../01-setup/)
* Azure Subscription
* Bicep CLI

## Exercises

This hands-on-lab has the following exercises:

1. [Exercise 0: Deploy resources](#ex0)
2. [Exercise 1: Assess and Migrate Application](#ex1)
3. [Exercise 2: Migrate Applications](#ex2)
4. [Exercise 3: Create GitHub workflow](#ex3)

### Exercise 0: Deploy resources

For this exercise, you're going to need an Azure SQL Database hydrated from a backup of your local database. The following template will deploy an Azure SQL Database and then use a BACPAC file of the IBuySpy database for the IBuySpy legacy application deployed in [HoL 1](../01-setup/). 

1. Clone this repository onto your jumpbox from the previous lab if you haven't already.
2. Open a new PowerShell Terminal
3. Authenticate using ```Connect-AzAccount``` to your Azure subscription
4. Run the [PowerShell Script](scripts/deploy_SQLDB.ps1)

After the script completes, you will see an Azure SQL Server and database in the resource group you specified in your subscription. This database will be used later in this lab. 

### Exercise 1: Assess legacy application

For this exercise, you're going to run PowerShell scripts that assess your application for migration to Azure App Service. 

1. Download the [Assessment and Migration scripts](https://azure.microsoft.com/products/app-service/migration-tools/)
   ![App Service Migration Download](media/App%20Migration%20Assistant%20.png)
2. Unzip the scripts into a folder of your choosing
3. Open a new PowerShell terminal in Admin mode by typing PowerShell into the Windows Search bar, right clicking on PowerShell and selecting *"Run as Administrator"*
4. Navigate to the folder where you unzipped the scripts
5. Run the application assessment script by running `.\Get-SiteReadiness.ps1`
6. After the script has completed, open the *ReadinessResults.json* file located in the same folder that was generated by the scripts.
7. You will see assessment results for the several applications. The result you want to pay attention to is the IBuySpyV3 application which is the one you will be migrating. 

### Exercise 2: Migrate the legacy application

For this exercise, you are going to run a PowerShell script to prepare the application for migration and another script to migrate it. 

#### Application Migration
1. In the same directory as the previous exercise, open a PowerShell Terminal in Admin mode
2. Run ```.\Get-SitePackage.ps1 -ReadinessResultsFilePath ReadinessResults.json -SiteName IBuySpyV3 -PackageResultsFileName "PackageResults.json"```
3. Prepare the migration settings for the migration script by running ```.\GenerateMigrationSettings.ps1```. It will prompt you to enter the following fields:
   1. Location = # Where you have your resource group and Azure SQL Database deployed
   2. Subscription Id = # Your Subscription ID
   3. Resource Group = # Where you have your Azure SQL Database deployed
4. After the script has finished, open the *MigrationSettings.json* file. Modify the site name to a unique name such as IBuySpy12345. The name here has to be globally unique for DNS resolution. 
5. Run ```.\Invoke-SiteMigration.ps1 -MigrationSettingsFilePath "MigrationSettings.json"```
6. After the script completes, you will see a new App Service Plan and App Service deployed in the Azure Portal.

Now we need to update the database connection to the application. When the application was running on the Virtual Machine, it was connecting a SQL database located on another Virtual Machine. Now that we have migrated our application to App Service and our SQL database to Azure SQL, we can have the application connect to the new Azure SQL database. This requires us to update the App Settings configuration in the App Service. 

#### Database Update
1. 

## Summary

In this hands-on lab, you learned how to:

* Migrate a database to Azure SQL PAAS using Azure SQL Migrate
* Create VS 2017 empty project
* Copy files from source apps
* Add to VSTS
* Create pipeline and deploy to the PAAS app service
* Update the connection string in the APP Settings of the app service

---
Copyright 2016 Microsoft Corporation. All rights reserved. Except where otherwise noted, these materials are licensed under the terms of the MIT License. You may use them according to the license as is most appropriate for your project. The terms of this license can be found at [https://opensource.org/licenses/MIT](https://opensource.org/licenses/MIT).