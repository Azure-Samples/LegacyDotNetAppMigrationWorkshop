# Migrate Source Apps to PaaS

## Overview

In this lab, you will learn how to migrate legacy applications to PaaS. You will learn how to:

* Migrate a legacy application from an Azure VM to Azure App Service
* Create a GitHub workflow and deploy the application to the Azure App Service
* Update the connection string in the App Settings of the App Service

## Prerequisites

* Legacy applications and environment from [previous lab](../01-setup/)
* Azure Subscription 

## Exercises

This hands-on-lab has the following exercises:

1. [Exercise 0: Deploy resources](#ex0)
2. [Exercise 1: Assess legacy application](#ex1)
3. [Exercise 2: Migrate legacy application](#ex2)
4. [Exercise 3: Setup GitHub workflow](#ex3)

### Exercise 0: Deploy resources<a name="ex0"></a>

For this exercise, you will be migrating the IBuySpy legacy application that is running in the environment you deployed in [HoL 1](../01-setup/). We will be demonstrating how to modernize your SQL database as apart of this exercise. You're going to need an Azure SQL Database hydrated from a backup of your local IBuySpy database. The following template will deploy an Azure SQL Database and then use a BACPAC file to hydrate the tables and data for you. 

1. Clone this repository onto your jumpbox in your HoL 1 environment if you haven't already.
2. Open the PowerShell Deployment script by running the following commands:
   ```
      cd scripts
      code deploy_SQLDB.ps1
   ```
3. Update the following values:
    - *resourceName* on line 11 to the name of the resource group where your environment from HoL 1 lives 
    - *sqlServerPassword* on line 14 to a secure password of your choosing
    - Ensure *location* matches the location of your resource group
   Save the file.
4. Open a new PowerShell Terminal
5. Authenticate using ```Connect-AzAccount``` to your Azure subscription
6. Run the [PowerShell Script](scripts/deploy_SQLDB.ps1)

After the script completes, you will see an Azure SQL Server, SQL database and KeyVault in the resource group you specified in your subscription. This database will be used later in this lab. 

### Exercise 1: Assess legacy application<a name="ex1"></a>

For this exercise, you're going to run PowerShell scripts that assess your application for migration to Azure App Service. These scripts are specifically targeted for .NET applications running on Azure VMs. For scenarios where applications are not running 

1. Download the [Assessment and Migration scripts](https://azure.microsoft.com/products/app-service/migration-tools/)
   ![App Service Migration Download](media/App%20Migration%20Assistant%20.png)
2. Unzip the scripts into a folder of your choosing
3. Open a new PowerShell terminal in Admin mode by typing PowerShell into the Windows Search bar, right clicking on PowerShell and selecting *Run as Administrator*
4. Navigate to the folder where you unzipped the scripts
5. Run the application assessment script by running `.\Get-SiteReadiness.ps1`
6. After the script has completed, open the *ReadinessResults.json* file located in the same folder that was generated by the scripts.
7. You will see assessment results for the several applications. The result you want to pay attention to is the IBuySpyV3 application which is the one you will be migrating. 

### Exercise 2: Migrate the legacy application<a name="ex2"></a>

For this exercise, you are going to run a PowerShell script to prepare the application for migration and another script to migrate it. 

#### Application Migration
1. In the same directory as the previous exercise, open a PowerShell Terminal in Admin mode
2. Run ```.\Get-SitePackage.ps1 -ReadinessResultsFilePath ReadinessResults.json -SiteName IBuySpyV3 -PackageResultsFileName "PackageResults.json"```
3. Prepare the migration settings for the migration script by running ```.\GenerateMigrationSettings.ps1```. It will prompt you to enter the following fields:
   1. Location = **Where you have your resource group and Azure SQL Database deployed**
   2. Subscription Id = **Your Subscription ID**
   3. Resource Group = **Where you have your Azure SQL Database deployed**
4. After the script has finished, open the *MigrationSettings.json* file. Modify the site name to a unique name such as IBuySpy12345. The name here has to be globally unique for DNS resolution. 
5. Run ```.\Invoke-SiteMigration.ps1 -MigrationSettingsFilePath "MigrationSettings.json"```
6. After the script completes, you will see a new App Service Plan and App Service deployed in the Azure Portal.

Now we need to update the database connection to the application. When the application was running on the Virtual Machine, it was connecting a SQL database located on another Virtual Machine. Now that we have migrated our application to App Service and our SQL database to Azure SQL, we can have the application connect to the new Azure SQL database. This requires us to update the App Settings configuration in the App Service. 

#### Database Update

As mentioned in the previous section, you have an Azure SQL database available in your resource group. It has been pre-populated with the appropriate tables and data necessary for the IBuySpy application. For your application to use this new database, you will add the connection string to the Azure SQL database to an Azure KeyVault as a secret and have the Azure App Service read from the KeyVault.

1. Create a System Assigned Managed Identity through App Service by going to Settings then Identity inside your App Service in the Azure Portal. Turn the button for Status to On and hit Save.
   ![App Service Managed Identity](media/App%20Service%20MI.jpg)
2. Navigate to your Azure KeyVault in the Portal. Go to Access control (IAM), click Add then Add role assignment. Select the KeyVault Secrets User role. On the next screen, select Managed identity then select your App Service Managed Identity from the dropdown and hit Select. Click Review + assign. Now your App Service has access to read the secrets in your KeyVault.
3. To create the secret with the database connection string, you will need to assign yourself the role of KeyVault Secrets Officer in the RBAC permissions of the KeyVault.

    Navigate to your Azure KeyVault in the Portal. Go to Access control (IAM), click Add then Add role assignment. Select the KeyVault Secrets Officer role. On the next screen, search for your username. Click Review + assign. Now you have access to manage the secrets in your KeyVault.

4. Grab the connection string from the SQL Database by going to you SQL database in the Portal then to Settings and then Connection Strings. Select the ADO.NET (SQL authentication) option and replace {your_password} with the password you provided in the Bicep deployment. 
5. Create a secret in the KeyVault with the value as the connection string by go to your KeyVault then Objects and Secrets
6. Select Generate/Import. Make the secret name something you will remember or save the name somewhere for reference. You will need it in a minute. The secret value should be the connection string from the previous step. Hit Create once you've filled out the secret name and value.

7. Go to the Configuration section in the app service. Add two environment variables:

    - ```DataConnectionString = ConnectionStringPaas```
    - ```ConnectionStringPaas = @Microsoft.KeyVault(SecretUri=https://{Your KeyVault name}.vault.azure.net/secrets/{Your Secret name}/) OR @Microsoft.KeyVault(VaultName=<Your KeyVault name>;SecretName={Your Secret name})```
  
    Hit Save and wait for the app to restart.

Once the app has successfully restarted, navigate to the URL for your application and you should be able to see the fully functional app with products listed on the site. If you do not see your application, check your connection string again in your Azure KeyVault.

### Exercise 3: Setup CI/CD <a name="ex3"></a>

Once you've migrated your application via zip file deployment as you did in [Exercise 2](#exercise-2-migrate-the-legacy-application), you can move your source code to a GitHub repository and setup continuous deployment with a GitHub workflow. In this exercise, we're going to copy the IBuySpyV3 source code to a new GitHub repository and enable CI/CD through Azure App Service. 

#### Setup Continuous Integration
1. If not already connected, connect to the jump box using Bastion via [RDP](https://learn.microsoft.com/azure/bastion/bastion-connect-vm-rdp-windows) or [SSH](https://learn.microsoft.com/en-us/azure/bastion/bastion-connect-vm-ssh-windows). See [HOL 1](../01-setup/) if you haven't deployed the infrastructure already. 
2. Login into your GitHub account. Create a new repository for your application.
3. Open a Git Bash terminal. 
4.  Clone the repository you just created to your jumpbox in a folder you . 
    ```bash
    mkdir source/repos
    cd source/repos
    git clone <Your GitHub repo URL>
    ```
5. Copy the code for your IBuySpyV3 application in the ```C:\inetpub\IBuySpyV3``` folder to your cloned GitHub repository.
6. Open a PowerShell terminal. 
7. Create a file called `.gitignore` in the root of the directory by running the following command:
   ```powershell
   cd source/repos
   dotnet new gitignore
   ```

8. The code below will add all the files to track and commit them to your GitHub repo. From the root directory of the project:

      ```bash
      git add -A
      git commit -am "feat: Add application files"
      git push -u origin --all
      ```
#### Continuous Deployment
Now that we have our application in a GitHub repository, we need to setup DevOps integration with Azure App Service.

1. Navigate to the App Service that the migration script created in [Exercise 2](#exercise-2-migrate-the-legacy-application).
2. Click on the *Deployment Center*
   ![App Service Deployment Center](media/App%20Service%20Deployment%20Center.png)
3. In the *Source* dropdown menu, select *GitHub* under *Continuous Deployment (CI/CD)*
4. Click *Authorize* and login to your GitHub account. 
5. Once logged in, select the *Organization* and *Repository* where your application code is located. For the *Branch*, select main.
6. Click *Configure runtime* to set the application version information. Set *Stack* equal to *.NET* then set *.NET version* to *ASP.NET V4.8*. Click *Save* to update the runtime settings.  
7. Leave the option to *Add a workflow* selected. This will create a default workflow and publish profile secret in your GitHub repository. 
8. Hit *Save* at the top to save your changes. 
   ![Full GitHub Deployment Setup](media/Deployment%20Center%20Setup%20App%20Service.png)
9. Navigate to your GitHub repository and go into the *Actions* tab. You will see your workflow running to deploy your application. 


## Summary

In this hands-on lab, you learned how to:
* Migrate a legacy application from an Azure VM to Azure App Service
* Create a GitHub workflow and deploy the application to the Azure App Service
* Update App Settings of an application through App Service

---
Copyright 2023 Microsoft Corporation. All rights reserved. Except where otherwise noted, these materials are licensed under the terms of the MIT License. You may use them according to the license as is most appropriate for your project. The terms of this license can be found at [https://opensource.org/licenses/MIT](https://opensource.org/licenses/MIT).